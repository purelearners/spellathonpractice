<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: https: file:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'; media-src * ">
    <title>Spellathon Master v5.2</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .menu-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #ddd;
        }
        .home-btn { padding: 8px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .score-display-menu { padding: 8px 15px; background: #e0e7ff; color: #667eea; border-radius: 6px; font-weight: 600; }
        .main-content { padding: 40px; }
        .section { display: none; }
        .section.active { display: block; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; margin: 5px; }
        .btn-success { background: #10b981; color: white; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-stop { background: #ff6b6b; color: white; }
        .btn-letter { padding: 12px 14px; margin: 3px; background: #667eea; color: white; border: 2px solid #667eea; border-radius: 6px; font-size: 1em; font-weight: bold; cursor: pointer; min-width: 38px; }
        .btn-letter:hover { transform: scale(1.08); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .card { padding: 25px; border: 3px solid #ddd; border-radius: 15px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .card:hover { transform: scale(1.02); border-color: #667eea; }
        .card h3 { color: #667eea; margin-bottom: 10px; font-size: 1.5em; }
        .progress-bar { width: 100%; height: 30px; background: #f0f0f0; border-radius: 15px; overflow: hidden; margin-bottom: 20px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.9em; }
        .word-display { text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 15px; margin-bottom: 20px; }
        .word-main { font-size: 3.5em; font-weight: bold; color: #667eea; margin-bottom: 15px; }
        .word-syllables { font-size: 2em; color: #764ba2; margin-bottom: 15px; font-weight: 600; }
        .word-ipa { font-size: 1.6em; color: #555; margin-bottom: 15px; font-style: italic; }
        .word-meaning { font-size: 1.1em; color: #333; margin-bottom: 15px; background: rgba(255,255,255,0.8); padding: 15px; border-radius: 8px; text-align: left; }
        .button-group { text-align: center; margin-bottom: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
        .grade-subject-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .selector-btn { padding: 15px 20px; background: #f0f0f0; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s; }
        .selector-btn:hover { background: #e0e0e0; }
        .selector-btn.selected { background: #667eea; color: white; border-color: #667eea; }
        .loading { text-align: center; padding: 40px; font-size: 1.3em; color: #667eea; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .completion-message { text-align: center; padding: 40px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 15px; margin: 20px 0; }
        .completion-message h2 { font-size: 2.5em; margin-bottom: 15px; }
        .completion-message p { font-size: 1.3em; }
        .selected-letters { text-align: center; font-size: 2.5em; font-weight: bold; color: #667eea; margin-bottom: 20px; padding: 20px; background: #f0f0f0; border-radius: 10px; min-height: 60px; letter-spacing: 8px; font-family: 'Courier New', monospace; word-break: break-all; }
        .letter-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 3px; padding: 20px 10px; background: #f9f9f9; border-radius: 15px; min-height: 120px; align-items: flex-start; }
        .feedback { text-align: center; margin: 20px 0; font-size: 1.3em; font-weight: bold; min-height: 30px; }
        .feedback.correct { color: #10b981; }
        .feedback.incorrect { color: #ef4444; }
        .marks-display { font-size: 1.3em; color: #667eea; font-weight: bold; text-align: center; margin-bottom: 15px; padding: 10px; background: #e0e7ff; border-radius: 10px; }
        .timer { font-size: 2.5em; color: #ef4444; font-weight: bold; text-align: center; margin-bottom: 20px; padding: 20px; background: #fff3cd; border-radius: 10px; border: 2px solid #ef4444; }
        .sets-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin: 20px 0; }
        .set-btn { padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; background: #f0f0f0; }
        .set-btn:hover { transform: scale(1.05); }
        .set-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .set-btn.completed { background: #10b981; color: white; border-color: #10b981; }
        .set-info { font-size: 1.2em; color: #667eea; font-weight: 600; text-align: center; margin-bottom: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; }
        .page-title { font-size: 1.5em; color: #667eea; font-weight: bold; margin-bottom: 20px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Spellathon Master v5.2</h1>
            <p>Learn ‚Üí Practice ‚Üí Test (Fixed Submission Logic)</p>
        </div>

        <div class="menu-bar" id="menuBar" style="display: none;">
            <div>
                <button class="home-btn" onclick="goHome()">üè† Home</button>
            </div>
            <div>
                <div class="score-display-menu">Score: <span id="sessionScore">0</span> words</div>
            </div>
        </div>

        <div class="main-content">
            <div class="section active" id="loadingSection">
                <div class="loading">
                    <p>Loading words from Google Sheets...</p>
                    <div class="loading-spinner"></div>
                </div>
            </div>

            <div class="section" id="gradeSelection">
                <h2 style="margin-bottom: 20px;">Select Grade</h2>
                <div class="grade-subject-grid" id="gradeButtons"></div>
            </div>

            <div class="section" id="subjectSelection">
                <h2 style="margin-bottom: 20px;">Select Subject</h2>
                <div class="grade-subject-grid" id="subjectButtons"></div>
            </div>

            <div class="section" id="modeSelection">
                <h2 style="text-align: center; margin-bottom: 30px;">Select Mode</h2>
                <div class="grid-2">
                    <div class="card" onclick="startLearning()">
                        <h3>üìö Learn & Practice</h3>
                        <p>Learn words then practice typing</p>
                    </div>
                    <div class="card" onclick="startTest()">
                        <h3>üß™ Test Yourself</h3>
                        <p>10 random words per set test</p>
                    </div>
                </div>
            </div>

            <div class="section" id="setSelectionSection">
                <h2 style="margin-bottom: 20px;">Select Set to Learn</h2>
                <div class="sets-grid" id="setsGrid"></div>
            </div>

            <!-- READING PAGE -->
            <div class="section" id="readingSection">
                <div class="page-title">üìñ Reading Page - Learn the Word</div>
                <div class="progress-bar"><div class="progress-fill" id="readingProgress">0%</div></div>
                <div class="word-display">
                    <div class="word-main" id="readingWord">Word</div>
                    <div class="word-syllables" id="readingSyllables">Syl-la-bles</div>
                    <div class="word-ipa" id="readingIPA">/word/</div>

                    <div class="button-group">
                        <button class="btn btn-success" onclick="playWordOnReading()">üîä Play Word</button>
                        <button class="btn btn-secondary" onclick="playLettersOnReading()">üîä Play Letters</button>
                        <button class="btn btn-secondary" onclick="playSyllablesOnReading()">üîä Play Syllables</button>
                        <button class="btn btn-stop" onclick="stopSpeaking()">Stop</button>
                    </div>

                    <div class="word-meaning" id="readingMeaning">Loading meaning...</div>

                    <div class="button-group" style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="previousWordReading()">‚Üê Previous</button>
                        <button class="btn btn-success" onclick="goToPracticePage()" style="font-size: 1.1em;">Next ‚Üí Practice</button>
                    </div>
                </div>
            </div>

            <!-- PRACTICE PAGE -->
            <div class="section" id="practiceSection">
                <div class="page-title">‚úèÔ∏è Practice Page - Type the Word</div>
                <div class="progress-bar"><div class="progress-fill" id="practiceProgress">0%</div></div>

                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="playWordOnPractice()">üîä Play Word</button>
                    <button class="btn btn-stop" onclick="stopSpeaking()">Stop</button>
                </div>

                <div class="selected-letters" id="practiceTyping">_</div>
                <div class="letter-buttons" id="practiceLetters"></div>
                <div class="feedback" id="practiceFeedback"></div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="clearPractice()">Clear</button>
                    <button class="btn btn-success" onclick="submitPractice()" style="font-size: 1.2em;">Submit</button>
                    <button class="btn btn-secondary" onclick="relearningClick()">Relearn</button>
                </div>
            </div>

            <div class="section" id="completionSection">
                <div class="completion-message">
                    <h2>üéâ Set Complete!</h2>
                    <p id="completionText">You've completed this set!</p>
                    <p style="margin-top: 20px; font-size: 1.5em;">Set Score: <span id="completionScore">0</span> words</p>
                    <div style="margin-top: 30px;">
                        <button class="btn btn-success" onclick="goBackToSets()" style="font-size: 1.2em;">Continue to Next Set</button>
                    </div>
                </div>
            </div>

            <div class="section" id="testSetSelectionSection">
                <h2 style="margin-bottom: 20px;">Select Set to Test</h2>
                <div class="set-info">Each test will have 10 random words from the selected set</div>
                <div class="sets-grid" id="testSetsGrid"></div>
            </div>

            <div class="section" id="testSection">
                <div class="marks-display">Completed: <span id="completedCount">0</span> | Marks: <span id="testMarksValue">0</span> / 10 | Set: <span id="currentTestSet">1</span></div>
                <div class="timer" id="testTimer">30</div>
                <div class="progress-bar"><div class="progress-fill" id="testProgress">0%</div></div>

                <div class="word-display">
                    <button class="btn btn-success" onclick="speakTestWord()" style="margin: 5px;">üîä Play Word</button>
                    <button class="btn btn-secondary" onclick="speakTestLetters()" id="testPlayLettersBtn" style="margin: 5px; display: none;">üîä Play Letters</button>
                    <button class="btn btn-stop" onclick="stopSpeaking()">Stop</button>
                </div>

                <div class="selected-letters" id="testTyping">_</div>
                <div class="letter-buttons" id="testLetters"></div>
                <div class="feedback" id="testFeedback"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="clearTest()">Clear</button>
                    <button class="btn btn-success" onclick="submitTest()">Submit</button>
                    <button class="btn btn-secondary" onclick="skipTest()">Skip</button>
                </div>
            </div>

            <div class="section" id="testCompletionSection">
                <div class="completion-message">
                    <h2>üéä Test Complete!</h2>
                    <p id="testCompletionText">Great job!</p>
                    <div style="margin-top: 30px;">
                        <button class="btn btn-success" onclick="goBackToTestSets()" style="font-size: 1.2em;">Back to Set Selection</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('deviceready', onDeviceReady, false);
        function onDeviceReady() {
            console.log('Cordova device ready');
            initializeApp();
        }

        var GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRh5GoW3bvEFhA9qODh5k6FJCFD-A4a_Fu4nb3irpPgWng6kyFlJ3m3Lrr-ZHFYo5thtEMeUJ8mVsqH/pub?output=csv';

        // ========== AUDIO FUNCTIONS ==========
        function stopSpeaking() {
            try {
                if (window.speechSynthesis) window.speechSynthesis.cancel();
                if (window.TTS) window.TTS.stop();
            } catch(e) {
                console.error('Stop error:', e);
            }
        }

        function playAudio(text) {
            try {
                stopSpeaking();
                if (window.TTS && typeof window.TTS.speak === 'function') {
                    window.TTS.speak({
                        text: text,
                        locale: 'en-US',
                        rate: 0.75
                    });
                } else if (window.speechSynthesis) {
                    var utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.7;
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    speechSynthesis.speak(utterance);
                }
            } catch (error) {
                console.error('Audio playback error:', error);
            }
        }

        function playWordOnReading() {
            if (currentLearnWords && currentLearnIndex < currentLearnWords.length) {
                playAudio(currentLearnWords[currentLearnIndex]);
            }
        }

        function playLettersOnReading() {
            var word = currentLearnWords[currentLearnIndex];
            var syllablesArray = getSyllablesArray(word);
            var delay = 0;
            for (var s = 0; s < syllablesArray.length; s++) {
                var syl = syllablesArray[s];
                var letters = syl.split('');
                for (var l = 0; l < letters.length; l++) {
                    (function(letter, d) {
                        setTimeout(function() { playAudio(letter); }, d);
                    })(letters[l], delay);
                    delay += 100;
                }
                delay += 800;
            }
        }

        function playSyllablesOnReading() {
            var word = currentLearnWords[currentLearnIndex];
            var syls = syllabify(word).split('-');
            var delay = 0;
            for (var i = 0; i < syls.length; i++) {
                (function(syl, d) {
                    setTimeout(function() { playAudio(syl); }, d);
                })(syls[i], delay);
                delay += 1000;
            }
        }

        function playWordOnPractice() {
            var word = currentLearnWords[currentLearnIndex];
            playAudio(word);
        }

        function speakTestWord() {
            var word = testWords[currentIndex];
            playAudio(word);
        }

        function speakTestLetters() {
            var word = testWords[currentIndex];
            var letters = word.split('');
            var d = 0;
            for (var i = 0; i < letters.length; i++) {
                (function(letter, delay) {
                    setTimeout(function() { playAudio(letter); }, delay);
                })(letters[i], d);
                d += 800;
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        async function getMeaningFromAPI(word) {
            try {
                var response = await fetch('https://api.dictionaryapi.dev/api/v2/entries/en/' + word.toLowerCase());
                if (response.ok) {
                    var data = await response.json();
                    if (data && data.length > 0 && data[0].meanings && data[0].meanings.length > 0) {
                        return data[0].meanings[0].definitions[0].definition;
                    }
                }
                return 'No meaning found.';
            } catch (error) {
                return 'Definition not available.';
            }
        }

        function syllabify(word) {
            var syllableRegex = /[^aeiouy]*[aeiouy]+(?:[^aeiouy]*$|[^aeiouy](?=[^aeiouy]))?/gi;
            var syllables = word.match(syllableRegex) || [word];
            return syllables.map(function(s) { return s.charAt(0).toUpperCase() + s.slice(1); }).join('-');
        }

        function getSyllablesArray(word) {
            var syllableRegex = /[^aeiouy]*[aeiouy]+(?:[^aeiouy]*$|[^aeiouy](?=[^aeiouy]))?/gi;
            return word.match(syllableRegex) || [word];
        }

        function generateIPAwithSyllables(word) {
            var syllables = getSyllablesArray(word);
            var ipaParts = [];
            for (var s = 0; s < syllables.length; s++) {
                var syl = syllables[s].toLowerCase();
                var sylIpa = '';
                for (var i = 0; i < syl.length; i++) {
                    var char = syl[i];
                    var next = i < syl.length - 1 ? syl[i + 1] : '';
                    if (char === 'a') sylIpa += (next === 'i' || next === 'y') ? 'e…™' : '√¶';
                    else if (char === 'e') sylIpa += (next === 'e') ? 'iÀê' : '…õ';
                    else if (char === 'i') sylIpa += '…™';
                    else if (char === 'o') sylIpa += '…í';
                    else if (char === 'u') sylIpa += ' å';
                    else sylIpa += char;
                }
                ipaParts.push(sylIpa);
            }
            return '/' + ipaParts.join('-') + '/';
        }

        function getRandomElements(arr, count) {
            var shuffled = arr.slice().sort(function() { return 0.5 - Math.random(); });
            return shuffled.slice(0, Math.min(count, arr.length));
        }

        // ========== STATE VARIABLES ==========
        var allWordsData = {};
        var currentGrade = '';
        var currentSubject = '';
        var currentIndex = 0;
        var currentSetIndex = 0;
        var currentTestSetIndex = 0;
        var allSubjectWords = [];
        var wordSets = [];
        var currentLearnWords = [];
        var currentLearnIndex = 0;
        var testWords = [];
        var sessionScore = 0;
        var subjectScores = {};
        var completedSets = [];
        var testMarks = 0;
        var testCompleted = 0;
        var testTotal = 0;
        var currentLetters = [];
        var testTimer = null;
        var testTimeLeft = 30;
        var testIsAutoAdvancing = false;
        var testIsWrongAttempt = false;
        var practiceLetters = [];
        var practiceAttempt = 0;
        var setScore = 0;

        // ========== INITIALIZATION ==========
        function initializeApp() {
            fetch(GOOGLE_SHEETS_CSV_URL)
                .then(function(response) { return response.text(); })
                .then(function(csvText) {
                    parseSheetData(csvText);
                    document.getElementById('loadingSection').classList.remove('active');
                    document.getElementById('gradeSelection').classList.add('active');
                    renderGradeButtons();
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    alert('Error loading data: ' + error.message);
                });
        }

        function parseSheetData(csv) {
            var allLines = [];
            var currentLine = '';
            for (var i = 0; i < csv.length; i++) {
                var ch = csv[i];
                if (ch === String.fromCharCode(10)) {
                    allLines.push(currentLine);
                    currentLine = '';
                } else if (ch === String.fromCharCode(13)) {
                    allLines.push(currentLine);
                    currentLine = '';
                    if (csv[i + 1] === String.fromCharCode(10)) i++;
                } else {
                    currentLine += ch;
                }
            }
            if (currentLine) allLines.push(currentLine);

            allWordsData = {};
            for (var i = 1; i < allLines.length; i++) {
                var line = allLines[i].trim();
                if (!line) continue;
                var parts = line.split(',');
                if (parts.length >= 3) {
                    var grade = parts[0].trim().replace(/^"|"$/g, '').trim();
                    var subject = parts[1].trim().replace(/^"|"$/g, '').trim();
                    var word = parts[2].trim().replace(/^"|"$/g, '').trim();
                    if (grade && subject && word) {
                        if (!allWordsData[grade]) allWordsData[grade] = {};
                        if (!allWordsData[grade][subject]) allWordsData[grade][subject] = [];
                        allWordsData[grade][subject].push(word);
                    }
                }
            }
        }

        // ========== GRADE & SUBJECT SELECTION ==========
        function renderGradeButtons() {
            var container = document.getElementById('gradeButtons');
            container.innerHTML = '';
            for (var grade in allWordsData) {
                var btn = document.createElement('button');
                btn.className = 'selector-btn';
                btn.textContent = grade;
                btn.onclick = (function(g) {
                    return function() { selectGrade(g); };
                })(grade);
                container.appendChild(btn);
            }
        }

        function selectGrade(grade) {
            currentGrade = grade;
            updateGradeDisplay(grade);
            renderSubjectButtons();
        }

        function updateGradeDisplay(grade) {
            var btns = document.getElementById('gradeButtons').getElementsByClassName('selector-btn');
            for (var i = 0; i < btns.length; i++) {
                if (btns[i].textContent === grade) btns[i].classList.add('selected');
                else btns[i].classList.remove('selected');
            }
        }

        function renderSubjectButtons() {
            var container = document.getElementById('subjectButtons');
            container.innerHTML = '';
            for (var subject in allWordsData[currentGrade]) {
                var btn = document.createElement('button');
                btn.className = 'selector-btn';
                btn.textContent = subject;
                btn.onclick = (function(s) {
                    return function() { selectSubject(s); };
                })(subject);
                container.appendChild(btn);
            }
            document.getElementById('gradeSelection').classList.remove('active');
            document.getElementById('subjectSelection').classList.add('active');
        }

        function selectSubject(subject) {
            currentSubject = subject;
            if (!subjectScores[subject]) subjectScores[subject] = 0;
            if (!completedSets[subject]) completedSets[subject] = [];
            updateSubjectDisplay(subject);
            document.getElementById('subjectSelection').classList.remove('active');
            document.getElementById('modeSelection').classList.add('active');
            document.getElementById('menuBar').style.display = 'flex';
        }

        function updateSubjectDisplay(subject) {
            var btns = document.getElementById('subjectButtons').getElementsByClassName('selector-btn');
            for (var i = 0; i < btns.length; i++) {
                if (btns[i].textContent === subject) btns[i].classList.add('selected');
                else btns[i].classList.remove('selected');
            }
        }

        // ========== LEARNING MODE WITH 20-WORD SETS ==========
        function startLearning() {
            allSubjectWords = allWordsData[currentGrade][currentSubject];
            if (!allSubjectWords || allSubjectWords.length === 0) {
                alert('No words found!');
                return;
            }

            wordSets = [];
            for (var i = 0; i < allSubjectWords.length; i += 20) {
                wordSets.push(allSubjectWords.slice(i, i + 20));
            }

            currentSetIndex = 0;
            document.getElementById('modeSelection').classList.remove('active');
            document.getElementById('setSelectionSection').classList.add('active');
            renderSetButtons();
        }

        function renderSetButtons() {
            var container = document.getElementById('setsGrid');
            container.innerHTML = '';
            for (var i = 0; i < wordSets.length; i++) {
                var btn = document.createElement('button');
                btn.className = 'set-btn';
                if (completedSets[currentSubject] && completedSets[currentSubject].indexOf(i) !== -1) {
                    btn.classList.add('completed');
                    btn.textContent = '‚úì Set ' + (i + 1);
                } else {
                    btn.textContent = 'Set ' + (i + 1);
                }
                btn.onclick = (function(setIdx) {
                    return function() { selectSet(setIdx); };
                })(i);
                container.appendChild(btn);
            }
        }

        function selectSet(setIdx) {
            currentSetIndex = setIdx;
            currentLearnWords = wordSets[setIdx];
            currentLearnIndex = 0;
            setScore = 0;
            document.getElementById('setSelectionSection').classList.remove('active');
            document.getElementById('readingSection').classList.add('active');
            displayReadingPage();
        }

        async function displayReadingPage() {
            if (currentLearnIndex >= currentLearnWords.length) {
                showSetCompletion();
                return;
            }

            var word = currentLearnWords[currentLearnIndex];
            document.getElementById('readingWord').textContent = word;
            document.getElementById('readingSyllables').textContent = syllabify(word);
            document.getElementById('readingIPA').textContent = generateIPAwithSyllables(word);
            document.getElementById('readingMeaning').textContent = 'Loading...';

            var progress = Math.round((currentLearnIndex + 1) / currentLearnWords.length * 100);
            document.getElementById('readingProgress').style.width = progress + '%';
            document.getElementById('readingProgress').textContent = (currentLearnIndex + 1) + '/' + currentLearnWords.length;

            var meaning = await getMeaningFromAPI(word);
            document.getElementById('readingMeaning').textContent = meaning;

            stopSpeaking();
            playWordOnReading();
        }

        function previousWordReading() {
            if (currentLearnIndex > 0) {
                currentLearnIndex--;
                displayReadingPage();
            }
        }

        function goToPracticePage() {
            stopSpeaking();
            practiceLetters = [];
            practiceAttempt = 0;
            document.getElementById('readingSection').classList.remove('active');
            document.getElementById('practiceSection').classList.add('active');
            displayPracticePage();
        }

        function displayPracticePage() {
            var progress = Math.round((currentLearnIndex + 1) / currentLearnWords.length * 100);
            document.getElementById('practiceProgress').style.width = progress + '%';
            document.getElementById('practiceProgress').textContent = (currentLearnIndex + 1) + '/' + currentLearnWords.length;
            generatePracticeLetterButtons();
            playWordOnPractice();
        }

        function generatePracticeLetterButtons() {
            var container = document.getElementById('practiceLetters');
            container.innerHTML = '';
            practiceLetters = [];
            var alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (var i = 0; i < alphabet.length; i++) {
                var letter = alphabet[i];
                var btn = document.createElement('button');
                btn.className = 'btn-letter';
                btn.textContent = letter;
                btn.onclick = (function(l) {
                    return function() { selectPracticeLetter(l); };
                })(letter);
                container.appendChild(btn);
            }
            document.getElementById('practiceTyping').textContent = '_';
            document.getElementById('practiceFeedback').textContent = '';
            practiceAttempt = 0;
        }

        function selectPracticeLetter(letter) {
            practiceLetters.push(letter);
            document.getElementById('practiceTyping').textContent = practiceLetters.join('');
        }

        function clearPractice() {
            practiceLetters = [];
            document.getElementById('practiceTyping').textContent = '_';
            document.getElementById('practiceFeedback').textContent = '';
            practiceAttempt = 0;
        }

        function submitPractice() {
            var typed = practiceLetters.join('');
            var correct = currentLearnWords[currentLearnIndex];

            console.log('Typed: "' + typed + '", Correct: "' + correct + '"');
            console.log('Typed lowercase: "' + typed.toLowerCase() + '", Correct lowercase: "' + correct.toLowerCase() + '"');

            if (typed.toLowerCase() === correct.toLowerCase()) {
                document.getElementById('practiceFeedback').textContent = '‚úì Correct!';
                document.getElementById('practiceFeedback').className = 'feedback correct';

                sessionScore++;
                subjectScores[currentSubject]++;
                setScore++;
                document.getElementById('sessionScore').textContent = sessionScore;

                setTimeout(function() {
                    currentLearnIndex++;
                    document.getElementById('practiceSection').classList.remove('active');
                    if (currentLearnIndex < currentLearnWords.length) {
                        document.getElementById('readingSection').classList.add('active');
                        displayReadingPage();
                    } else {
                        showSetCompletion();
                    }
                }, 1000);
            } else {
                practiceAttempt++;
                if (practiceAttempt === 1) {
                    document.getElementById('practiceFeedback').textContent = '‚ùå Try again!';
                    document.getElementById('practiceFeedback').className = 'feedback incorrect';
                } else {
                    document.getElementById('practiceFeedback').textContent = '‚ùå Wrong: ' + correct;
                    document.getElementById('practiceFeedback').className = 'feedback incorrect';
                }
            }
        }

        function relearningClick() {
            document.getElementById('practiceSection').classList.remove('active');
            document.getElementById('readingSection').classList.add('active');
            displayReadingPage();
        }

        function showSetCompletion() {
            if (!completedSets[currentSubject]) completedSets[currentSubject] = [];
            if (completedSets[currentSubject].indexOf(currentSetIndex) === -1) {
                completedSets[currentSubject].push(currentSetIndex);
            }

            document.getElementById('completionText').textContent = 'üéâ Set ' + (currentSetIndex + 1) + ' Complete!';
            document.getElementById('completionScore').textContent = setScore;
            document.getElementById('readingSection').classList.remove('active');
            document.getElementById('practiceSection').classList.remove('active');
            document.getElementById('completionSection').classList.add('active');
        }

        function goBackToSets() {
            document.getElementById('completionSection').classList.remove('active');
            document.getElementById('setSelectionSection').classList.add('active');
            renderSetButtons();
        }

        // ========== TEST MODE ==========
        function startTest() {
            allSubjectWords = allWordsData[currentGrade][currentSubject];
            if (!allSubjectWords || allSubjectWords.length === 0) {
                alert('No words found!');
                return;
            }

            wordSets = [];
            for (var i = 0; i < allSubjectWords.length; i += 20) {
                wordSets.push(allSubjectWords.slice(i, i + 20));
            }

            currentTestSetIndex = 0;
            document.getElementById('modeSelection').classList.remove('active');
            document.getElementById('testSetSelectionSection').classList.add('active');
            renderTestSetButtons();
        }

        function renderTestSetButtons() {
            var container = document.getElementById('testSetsGrid');
            container.innerHTML = '';
            for (var i = 0; i < wordSets.length; i++) {
                var btn = document.createElement('button');
                btn.className = 'set-btn';
                btn.textContent = 'Test Set ' + (i + 1);
                btn.onclick = (function(setIdx) {
                    return function() { startSetTest(setIdx); };
                })(i);
                container.appendChild(btn);
            }
        }

        function startSetTest(setIdx) {
            currentTestSetIndex = setIdx;
            var setWords = wordSets[setIdx];
            testWords = getRandomElements(setWords, 10);
            startTestMode();
        }

        function startTestMode() {
            if (!testWords || testWords.length === 0) {
                alert('No words found!');
                return;
            }
            currentIndex = 0;
            testMarks = 0;
            testCompleted = 0;
            testTotal = testWords.length;

            document.getElementById('testSetSelectionSection').classList.remove('active');
            document.getElementById('testSection').classList.add('active');
            document.getElementById('currentTestSet').textContent = (currentTestSetIndex + 1);

            document.getElementById('testMarksValue').textContent = testMarks;
            document.getElementById('completedCount').textContent = testCompleted;

            generateTestLetterButtons();
            updateTestDisplay();
            startTestTimer();
            setTimeout(function() { speakTestWord(); }, 500);
        }

        function startTestTimer() {
            testTimeLeft = 30;
            if (testTimer) clearInterval(testTimer);
            testTimer = setInterval(function() {
                testTimeLeft--;
                document.getElementById('testTimer').textContent = testTimeLeft;
                if (testTimeLeft <= 0) {
                    clearInterval(testTimer);
                    moveToNextTestWord();
                }
            }, 1000);
        }

        function generateTestLetterButtons() {
            var container = document.getElementById('testLetters');
            container.innerHTML = '';
            currentLetters = [];
            var alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (var i = 0; i < alphabet.length; i++) {
                var letter = alphabet[i];
                var btn = document.createElement('button');
                btn.className = 'btn-letter';
                btn.textContent = letter;
                btn.onclick = (function(l) {
                    return function() { selectTestLetter(l); };
                })(letter);
                container.appendChild(btn);
            }
            document.getElementById('testTyping').textContent = '_';
            document.getElementById('testPlayLettersBtn').style.display = 'none';
            document.getElementById('testFeedback').textContent = '';
            testIsWrongAttempt = false;
        }

        function selectTestLetter(letter) {
            currentLetters.push(letter);
            document.getElementById('testTyping').textContent = currentLetters.join('');
        }

        function clearTest() {
            currentLetters = [];
            document.getElementById('testTyping').textContent = '_';
        }

        function submitTest() {
            if (testIsAutoAdvancing) return;
            var typed = currentLetters.join('');
            var correct = testWords[currentIndex];

            if (typed.toLowerCase() === correct.toLowerCase()) {
                var feedbackEl = document.getElementById('testFeedback');
                feedbackEl.textContent = '+1 Point!';
                feedbackEl.className = 'feedback correct';

                testMarks++;
                testCompleted++;
                sessionScore++;

                document.getElementById('testMarksValue').textContent = testMarks;
                document.getElementById('completedCount').textContent = testCompleted;
                document.getElementById('sessionScore').textContent = sessionScore;

                testIsAutoAdvancing = true;
                stopSpeaking();
                clearInterval(testTimer);
                setTimeout(function() {
                    testIsAutoAdvancing = false;
                    moveToNextTestWord();
                }, 1000);
            } else {
                if (!testIsWrongAttempt) {
                    testIsWrongAttempt = true;
                    document.getElementById('testFeedback').textContent = '‚ùå Incorrect. Try again or use Play Letters.';
                    document.getElementById('testFeedback').className = 'feedback incorrect';
                    document.getElementById('testPlayLettersBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('testFeedback').textContent = '‚ùå Wrong: ' + correct;
                    document.getElementById('testFeedback').className = 'feedback incorrect';
                }
            }
        }

        function skipTest() {
            document.getElementById('testFeedback').textContent = 'Skipped';
            document.getElementById('testFeedback').className = 'feedback incorrect';
            setTimeout(function() { moveToNextTestWord(); }, 1500);
        }

        function moveToNextTestWord() {
            stopSpeaking();
            currentIndex++;
            if (currentIndex >= testWords.length) {
                endTest();
            } else {
                clearTest();
                generateTestLetterButtons();
                updateTestDisplay();
                startTestTimer();
                setTimeout(function() { speakTestWord(); }, 500);
            }
        }

        function updateTestDisplay() {
            var progress = Math.round(currentIndex / testWords.length * 100);
            document.getElementById('testProgress').style.width = progress + '%';
            document.getElementById('testProgress').textContent = currentIndex + '/' + testWords.length;
        }

        function endTest() {
            clearInterval(testTimer);
            stopSpeaking();
            var percentage = Math.round(testMarks / testTotal * 100);
            document.getElementById('testCompletionText').innerHTML = 
                '<p style="font-size: 1.5em; margin: 20px 0;">Set ' + (currentTestSetIndex + 1) + ' Test Complete!</p>' +
                '<p style="font-size: 1.5em; margin: 20px 0;">Completed: ' + testCompleted + ' words</p>' +
                '<p style="font-size: 1.8em; margin: 20px 0;">Marks: ' + testMarks + ' / ' + testTotal + '</p>' +
                '<p style="font-size: 1.5em;">Score: ' + percentage + '%</p>';

            document.getElementById('testSection').classList.remove('active');
            document.getElementById('testCompletionSection').classList.add('active');
        }

        function goBackToTestSets() {
            document.getElementById('testCompletionSection').classList.remove('active');
            document.getElementById('testSetSelectionSection').classList.add('active');
        }

        // ========== NAVIGATION ==========
        function goHome() {
            stopSpeaking();
            if (testTimer) clearInterval(testTimer);
            document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
            document.getElementById('gradeSelection').classList.add('active');
            document.getElementById('menuBar').style.display = 'none';
            currentGrade = '';
            currentSubject = '';
            renderGradeButtons();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                if (!window.cordova) {
                    initializeApp();
                }
            });
        } else {
            if (!window.cordova) {
                initializeApp();
            }
        }
    </script>
</body>
</html>
