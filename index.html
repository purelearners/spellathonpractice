<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spellathon Master</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .main-content { padding: 40px; }
        .section { display: none; }
        .section.active { display: block; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; margin: 5px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-stop { background: #ff6b6b; color: white; }
        .btn-letter { padding: 12px 14px; margin: 3px; background: #667eea; color: white; border: 2px solid #667eea; border-radius: 6px; font-size: 1em; font-weight: bold; cursor: pointer; min-width: 38px; text-align: center; flex-shrink: 0; }
        .btn-letter:hover { transform: scale(1.08); }
        .btn-backspace { padding: 12px 18px; margin: 3px; background: #ef4444; color: white; border: 2px solid #ef4444; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-backspace:disabled { background: #ccc; opacity: 0.5; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .card { padding: 25px; border: 3px solid #ddd; border-radius: 15px; text-align: center; cursor: pointer; }
        .card h3 { color: #667eea; margin-bottom: 10px; font-size: 1.5em; }
        .progress-bar { width: 100%; height: 30px; background: #f0f0f0; border-radius: 15px; overflow: hidden; margin-bottom: 20px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.9em; }
        .word-display { text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 15px; margin-bottom: 30px; }
        .word-main { font-size: 3.5em; font-weight: bold; color: #667eea; margin-bottom: 15px; }
        .word-syllables { font-size: 2em; color: #764ba2; margin-bottom: 10px; font-weight: 600; }
        .word-ipa { font-size: 1.6em; color: #555; margin-bottom: 15px; font-style: italic; }
        .word-meaning { font-size: 1.2em; color: #333; margin-bottom: 15px; background: rgba(255,255,255,0.8); padding: 15px; border-radius: 8px; line-height: 1.8; text-align: left; }
        .timer { font-size: 2.5em; color: #ef4444; font-weight: bold; text-align: center; margin-bottom: 20px; padding: 20px; background: #fff3cd; border-radius: 10px; border: 2px solid #ef4444; }
        .marks-display { font-size: 1.3em; color: #667eea; font-weight: bold; text-align: center; margin-bottom: 15px; padding: 10px; background: #e0e7ff; border-radius: 10px; }
        .score-display { font-size: 1.8em; color: #10b981; font-weight: bold; text-align: center; margin-bottom: 20px; padding: 15px; background: #ecfdf5; border-radius: 10px; border: 2px solid #10b981; }
        .letter-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 3px; padding: 20px 10px; background: #f9f9f9; border-radius: 15px; min-height: 120px; align-items: flex-start; }
        .selected-letters { text-align: center; font-size: 2.5em; font-weight: bold; color: #667eea; margin-bottom: 20px; padding: 20px; background: #f0f0f0; border-radius: 10px; min-height: 60px; letter-spacing: 8px; font-family: 'Courier New', monospace; }
        .feedback { text-align: center; margin: 20px 0; font-size: 1.3em; font-weight: bold; min-height: 30px; }
        .feedback.correct { color: #10b981; }
        .feedback.incorrect { color: #ef4444; }
        .bubble { position: relative; display: inline-block; animation: popBubble 1s ease-out; }
        @keyframes popBubble { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        .grade-subject-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .selector-btn { padding: 15px 20px; background: #f0f0f0; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; }
        .selector-btn.selected { background: #667eea; color: white; border-color: #667eea; }
        .loading { text-align: center; padding: 40px; font-size: 1.3em; color: #667eea; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Spellathon Master v3.0</h1>
            <p>Enhanced Learning with Dynamic Sets & Smart Practice</p>
        </div>
        <div class="main-content">
            <div class="section active" id="loadingSection">
                <div class="loading">
                    <p>Loading words from Google Sheets...</p>
                    <div class="loading-spinner"></div>
                </div>
            </div>
            <div class="section" id="modeSelection">
                <h2 style="text-align: center; margin-bottom: 30px;">Select Mode</h2>
                <div class="grid-2">
                    <div class="card" onclick="startLearningMode()">
                        <h3>Learn</h3>
                        <p>Study words with meanings, IPA, and syllables.</p>
                    </div>
                    <div class="card" onclick="startPracticeMode()">
                        <h3>Practice</h3>
                        <p>Smart sets with scoring and conditional flows.</p>
                    </div>
                </div>
            </div>
            <div class="section" id="gradeSubjectSelection">
                <h2 style="margin-bottom: 20px;">Select Grade & Subject (Learn)</h2>
                <h3 style="margin-bottom: 10px;">Grade:</h3>
                <div class="grade-subject-grid" id="gradeButtons"></div>
                <h3 style="margin-bottom: 10px; margin-top: 20px;">Subject:</h3>
                <div class="grade-subject-grid" id="subjectButtons"></div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="startLearningWithSelection()">Start</button>
                    <button class="btn btn-danger" onclick="backToMode()">Back</button>
                </div>
            </div>
            <div class="section" id="learningSection">
                <div class="progress-bar"><div class="progress-fill" id="learnProgress">0%</div></div>
                <div class="word-display">
                    <div class="word-main" id="learnWord">Word</div>
                    <div class="word-ipa" id="learnIPA">/word/</div>
                    <div class="word-meaning" id="learnMeaning">Loading meaning...</div>
                    <button class="btn btn-secondary" onclick="showSyllables()" id="showSyllBtn" style="margin: 5px;">Show Syllables</button>
                    <button class="btn btn-stop" onclick="stopSpeaking()">Stop</button>
                    <div class="word-syllables" id="learnSyllables" style="display: none; margin-top: 15px;">Syl-la-bles</div>
                    <button class="btn btn-secondary" onclick="speakSyllables()" id="hearSyllBtn" style="display: none; margin: 5px;">Hear Syllables</button>
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-secondary" onclick="previousLearningWord()" style="margin: 5px;">Previous</button>
                    <button class="btn btn-secondary" onclick="nextLearningWord()" style="margin: 5px;">Next</button>
                    <button class="btn btn-danger" onclick="exitToMode()">Exit</button>
                </div>
            </div>
            <div class="section" id="gradeSubjectSelectionPractice">
                <h2 style="margin-bottom: 20px;">Select Grade & Subject (Practice)</h2>
                <h3 style="margin-bottom: 10px;">Grade:</h3>
                <div class="grade-subject-grid" id="gradeButtonsPractice"></div>
                <h3 style="margin-bottom: 10px; margin-top: 20px;">Subject:</h3>
                <div class="grade-subject-grid" id="subjectButtonsPractice"></div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="startPracticeWithSelection()">Start</button>
                    <button class="btn btn-danger" onclick="backToMode()">Back</button>
                </div>
            </div>
            <div class="section" id="practiceSetSelection">
                <h2 style="margin-bottom: 20px;">Select Practice Set</h2>
                <div class="grid-3" id="setButtons"></div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-danger" onclick="backToMode()">Back</button>
                </div>
            </div>
            <div class="section" id="practiceSection">
                <div class="marks-display">Marks: <span id="marksValue">0</span> / <span id="totalMarks">0</span></div>
                <div class="timer" id="timer">30</div>
                <div class="progress-bar"><div class="progress-fill" id="practiceProgress">0%</div></div>
                <div class="word-display">
                    <button class="btn btn-success" onclick="speakPracticeWord()" style="margin: 5px;">Play Word</button>
                    <button class="btn btn-secondary" onclick="speakPracticeLetters()" id="playLettersBtn" style="margin: 5px; display: none;">Play Letters</button>
                    <button class="btn btn-stop" onclick="stopSpeaking()">Stop</button>
                </div>
                <div class="selected-letters" id="selectedLetters">_</div>
                <div class="letter-buttons" id="letterButtons"></div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn-backspace" id="backspaceBtn" onclick="backspaceLetters()" disabled>Backspace</button>
                </div>
                <div class="feedback" id="feedback"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="clearLetters()">Clear</button>
                    <button class="btn btn-success" onclick="submitSpelling()">Submit</button>
                    <button class="btn btn-secondary" onclick="skipWord()">Skip</button>
                    <button class="btn btn-danger" onclick="exitPractice()">Exit</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        var GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRh5GoW3bvEFhA9qODh5k6FJCFD-A4a_Fu4nb3irpPgWng6kyFlJ3m3Lrr-ZHFYo5thtEMeUJ8mVsqH/pub?output=csv';

        async function getMeaningFromAPI(word) {
            try {
                var response = await fetch('https://api.dictionaryapi.dev/api/v2/entries/en/' + word.toLowerCase());
                if (response.ok) {
                    var data = await response.json();
                    if (data && data.length > 0) {
                        var meanings = data[0].meanings;
                        if (meanings && meanings.length > 0) {
                            var definition = meanings[0].definitions[0].definition;
                            return definition;
                        }
                    }
                }
                return 'Definition not found.';
            } catch (error) {
                return 'Definition not available (API offline).';
            }
        }

        function syllabify(word) {
            var syllableRegex = /[^aeiouy]*[aeiouy]+(?:[^aeiouy]*$|[^aeiouy](?=[^aeiouy]))?/gi;
            var syllables = word.match(syllableRegex) || [word];
            return syllables.map(function(s) { return s.charAt(0).toUpperCase() + s.slice(1); }).join('-');
        }

        function generateIPA(word) {
            var lower = word.toLowerCase();
            var ipa = '/';
            for (var i = 0; i < lower.length; i++) {
                var char = lower[i];
                var next = i < lower.length - 1 ? lower[i + 1] : '';
                if (char === 'a') ipa += (next === 'i' || next === 'y') ? 'eɪ' : 'æ';
                else if (char === 'e') ipa += (next === 'e') ? 'iː' : 'ɛ';
                else if (char === 'i') ipa += 'ɪ';
                else if (char === 'o') ipa += 'ɒ';
                else if (char === 'u') ipa += 'ʌ';
                else if (char !== ' ') ipa += char;
            }
            ipa += '/';
            return ipa;
        }

        function stopSpeaking() {
            if (window.speechSynthesis) window.speechSynthesis.cancel();
        }

        var allWordsData = {};
        var currentGrade = '';
        var currentSubject = '';
        var currentIndex = 0;
        var currentLetters = [];
        var marks = 0;
        var totalMarks = 0;
        var wordTimer = null;
        var learnTimer = null;
        var timeLeft = 30;
        var isAutoAdvancing = false;
        var isWrongAttempt = false;
        var currentSet = 0;
        var practiceWords = [];
        var allSubjectsMode = false;

        function initializeApp() {
            fetch(GOOGLE_SHEETS_CSV_URL)
                .then(function(response) { return response.text(); })
                .then(function(csvText) {
                    parseSheetData(csvText);
                    document.getElementById('loadingSection').classList.remove('active');
                    document.getElementById('modeSelection').classList.add('active');
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    alert('Error: ' + error.message);
                    document.getElementById('loadingSection').classList.remove('active');
                    document.getElementById('modeSelection').classList.add('active');
                });
        }

        function parseSheetData(csv) {
            var allLines = [];
            var currentLine = '';

            for (var i = 0; i < csv.length; i++) {
                var ch = csv[i];
                if (ch === String.fromCharCode(10)) {
                    allLines.push(currentLine);
                    currentLine = '';
                } else if (ch === String.fromCharCode(13)) {
                    allLines.push(currentLine);
                    currentLine = '';
                    if (csv[i + 1] === String.fromCharCode(10)) i++;
                } else {
                    currentLine += ch;
                }
            }
            if (currentLine) allLines.push(currentLine);

            allWordsData = {};
            for (var i = 1; i < allLines.length; i++) {
                var line = allLines[i].trim();
                if (!line) continue;

                var parts = line.split(',');
                if (parts.length >= 3) {
                    var grade = parts[0].trim().replace(/^"|"$/g, '').trim();
                    var subject = parts[1].trim().replace(/^"|"$/g, '').trim();
                    var word = parts[2].trim().replace(/^"|"$/g, '').trim();

                    if (grade && subject && word) {
                        if (!allWordsData[grade]) allWordsData[grade] = {};
                        if (!allWordsData[grade][subject]) allWordsData[grade][subject] = [];
                        allWordsData[grade][subject].push(word);
                    }
                }
            }
        }

        function startLearningMode() {
            currentGrade = '';
            currentSubject = '';
            currentIndex = 0;
            document.getElementById('modeSelection').classList.remove('active');
            document.getElementById('gradeSubjectSelection').classList.add('active');
            renderGradeButtons('gradeButtons', 'selectGradeLearning');
        }

        function startPracticeMode() {
            currentGrade = '';
            currentSubject = '';
            currentIndex = 0;
            document.getElementById('modeSelection').classList.remove('active');
            document.getElementById('gradeSubjectSelectionPractice').classList.add('active');
            renderGradeButtons('gradeButtonsPractice', 'selectGradePractice');
        }

        function renderGradeButtons(containerId, functionName) {
            var container = document.getElementById(containerId);
            container.innerHTML = '';
            for (var grade in allWordsData) {
                var btn = document.createElement('button');
                btn.className = 'selector-btn';
                btn.textContent = grade;
                btn.onclick = (function(g, fn) {
                    return function() {
                        if (fn === 'selectGradeLearning') selectGradeLearning(g);
                        else selectGradePractice(g);
                    };
                })(grade, functionName);
                container.appendChild(btn);
            }
        }

        function selectGradeLearning(grade) {
            currentGrade = grade;
            updateGradeDisplay('gradeButtons', grade);
            renderSubjectButtons('subjectButtons', 'selectSubjectLearning');
        }

        function selectGradePractice(grade) {
            currentGrade = grade;
            updateGradeDisplay('gradeButtonsPractice', grade);
            renderSubjectButtons('subjectButtonsPractice', 'selectSubjectPractice');
        }

        function updateGradeDisplay(id, grade) {
            var btns = document.getElementById(id).getElementsByClassName('selector-btn');
            for (var i = 0; i < btns.length; i++) {
                if (btns[i].textContent === grade) btns[i].classList.add('selected');
                else btns[i].classList.remove('selected');
            }
        }

        function renderSubjectButtons(containerId, functionName) {
            var container = document.getElementById(containerId);
            container.innerHTML = '';

            var btn = document.createElement('button');
            btn.className = 'selector-btn';
            btn.textContent = 'All Subjects';
            btn.onclick = (function(fn) {
                return function() {
                    currentSubject = 'ALL';
                    if (fn === 'selectSubjectLearning') startLearningWithSelection();
                    else startPracticeWithSelection();
                };
            })(functionName);
            container.appendChild(btn);

            for (var subject in allWordsData[currentGrade]) {
                var btn2 = document.createElement('button');
                btn2.className = 'selector-btn';
                btn2.textContent = subject;
                btn2.onclick = (function(s, fn) {
                    return function() {
                        currentSubject = s;
                        if (fn === 'selectSubjectLearning') startLearningWithSelection();
                        else startPracticeWithSelection();
                    };
                })(subject, functionName);
                container.appendChild(btn2);
            }
        }

        function startLearningWithSelection() {
            if (!currentGrade || !currentSubject) {
                alert('Select Grade and Subject');
                return;
            }
            currentIndex = 0;
            document.getElementById('gradeSubjectSelection').classList.remove('active');
            document.getElementById('learningSection').classList.add('active');
            displayLearningWord();
        }

        function startPracticeWithSelection() {
            if (!currentGrade || !currentSubject) {
                alert('Select Grade and Subject');
                return;
            }
            allSubjectsMode = currentSubject === 'ALL';
            createPracticeSets();
        }

        function createPracticeSets() {
            var allWords = [];
            if (allSubjectsMode) {
                for (var subject in allWordsData[currentGrade]) {
                    allWords = allWords.concat(allWordsData[currentGrade][subject]);
                }
            } else {
                allWords = allWordsData[currentGrade][currentSubject];
            }

            if (allWords.length === 0) {
                alert('No words found');
                return;
            }

            var setSize = 10;
            var numSets = Math.ceil(allWords.length / setSize);
            var container = document.getElementById('setButtons');
            container.innerHTML = '';

            for (var i = 0; i < numSets; i++) {
                var btn = document.createElement('button');
                btn.className = 'selector-btn';
                var startWord = i * setSize + 1;
                var endWord = Math.min((i + 1) * setSize, allWords.length);
                btn.textContent = 'Set ' + (i + 1) + ' (' + startWord + '-' + endWord + ')';
                btn.onclick = (function(setNum) {
                    return function() { startPracticeWithSet(setNum, allWords); };
                })(i);
                container.appendChild(btn);
            }

            document.getElementById('gradeSubjectSelectionPractice').classList.remove('active');
            document.getElementById('practiceSetSelection').classList.add('active');
        }

        function startPracticeWithSet(setNum, allWords) {
            currentSet = setNum;
            var setSize = 10;
            var startIdx = setNum * setSize;
            var endIdx = Math.min(startIdx + setSize, allWords.length);
            practiceWords = allWords.slice(startIdx, endIdx);

            currentIndex = 0;
            marks = 0;
            totalMarks = practiceWords.length;
            document.getElementById('totalMarks').textContent = totalMarks;

            document.getElementById('practiceSetSelection').classList.remove('active');
            document.getElementById('practiceSection').classList.add('active');

            generateAlphabetButtons();
            updatePracticeDisplay();
            startWordTimer();
            setTimeout(function() {
                speakPracticeWord();
            }, 500);
        }

        async function displayLearningWord() {
            var words = currentSubject === 'ALL' ? getAllWords() : allWordsData[currentGrade][currentSubject];
            if (currentIndex >= words.length) {
                alert('All words completed!');
                exitToMode();
                return;
            }
            var word = words[currentIndex];
            document.getElementById('learnWord').textContent = word;
            document.getElementById('learnIPA').textContent = generateIPA(word);
            document.getElementById('learnMeaning').textContent = 'Loading...';
            document.getElementById('learnSyllables').textContent = syllabify(word);
            document.getElementById('showSyllBtn').style.display = 'inline-block';
            document.getElementById('learnSyllables').style.display = 'none';

            var progress = Math.round((currentIndex + 1) / words.length * 100);
            document.getElementById('learnProgress').style.width = progress + '%';
            document.getElementById('learnProgress').textContent = (currentIndex + 1) + '/' + words.length;

            var meaning = await getMeaningFromAPI(word);
            document.getElementById('learnMeaning').textContent = meaning;

            stopSpeaking();
            if (learnTimer) clearTimeout(learnTimer);
            speakFullWord();

            learnTimer = setTimeout(function() {
                speakLettersAndAutoNext();
            }, 3500);
        }

        function getAllWords() {
            var allWords = [];
            for (var subject in allWordsData[currentGrade]) {
                allWords = allWords.concat(allWordsData[currentGrade][subject]);
            }
            return allWords;
        }

        function previousLearningWord() {
            if (learnTimer) clearTimeout(learnTimer);
            stopSpeaking();
            if (currentIndex > 0) {
                currentIndex--;
                displayLearningWord();
            }
        }

        function nextLearningWord() {
            if (learnTimer) clearTimeout(learnTimer);
            stopSpeaking();
            var words = currentSubject === 'ALL' ? getAllWords() : allWordsData[currentGrade][currentSubject];
            if (currentIndex < words.length - 1) {
                currentIndex++;
                displayLearningWord();
            }
        }

        function showSyllables() {
            if (learnTimer) clearTimeout(learnTimer);
            stopSpeaking();
            document.getElementById('learnSyllables').style.display = 'block';
            document.getElementById('showSyllBtn').style.display = 'none';
        }

        function speakFullWord() {
            stopSpeaking();
            var words = currentSubject === 'ALL' ? getAllWords() : allWordsData[currentGrade][currentSubject];
            var word = words[currentIndex];
            var u = new SpeechSynthesisUtterance(word);
            u.rate = 0.8;
            speechSynthesis.speak(u);
        }

        function speakLettersAndAutoNext() {
            stopSpeaking();
            var words = currentSubject === 'ALL' ? getAllWords() : allWordsData[currentGrade][currentSubject];
            var word = words[currentIndex];
            var letters = word.split('');
            var d = 0;
            for (var i = 0; i < letters.length; i++) {
                (function(letter, delay) {
                    setTimeout(function() {
                        var u = new SpeechSynthesisUtterance(letter);
                        u.rate = 0.7;
                        speechSynthesis.speak(u);
                    }, delay);
                })(letters[i], d);
                d += 800;
            }

            var totalDelay = letters.length * 800 + 1000;
            learnTimer = setTimeout(function() {
                nextLearningWord();
            }, totalDelay);
        }

        function speakSyllables() {
            if (learnTimer) clearTimeout(learnTimer);
            stopSpeaking();
            var words = currentSubject === 'ALL' ? getAllWords() : allWordsData[currentGrade][currentSubject];
            var word = words[currentIndex];
            var syls = syllabify(word).split('-');
            var d = 0;
            for (var i = 0; i < syls.length; i++) {
                (function(syl, delay) {
                    setTimeout(function() {
                        var u = new SpeechSynthesisUtterance(syl);
                        u.rate = 0.7;
                        speechSynthesis.speak(u);
                    }, delay);
                })(syls[i], d);
                d += 800;
            }
        }

        function speakPracticeWord() {
            stopSpeaking();
            var word = practiceWords[currentIndex];
            var u = new SpeechSynthesisUtterance(word);
            u.rate = 0.8;
            speechSynthesis.speak(u);
        }

        function speakPracticeLetters() {
            stopSpeaking();
            var word = practiceWords[currentIndex];
            var letters = word.split('');
            var d = 0;
            for (var i = 0; i < letters.length; i++) {
                (function(letter, delay) {
                    setTimeout(function() {
                        var u = new SpeechSynthesisUtterance(letter);
                        u.rate = 0.7;
                        speechSynthesis.speak(u);
                    }, delay);
                })(letters[i], d);
                d += 800;
            }
        }

        function startWordTimer() {
            timeLeft = 30;
            if (wordTimer) clearInterval(wordTimer);
            wordTimer = setInterval(function() {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(wordTimer);
                    moveToNextWord();
                }
            }, 1000);
        }

        function generateAlphabetButtons() {
            var container = document.getElementById('letterButtons');
            container.innerHTML = '';
            currentLetters = [];
            var alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (var i = 0; i < alphabet.length; i++) {
                var letter = alphabet[i];
                var btn = document.createElement('button');
                btn.className = 'btn-letter';
                btn.textContent = letter;
                btn.onclick = (function(l) {
                    return function() { selectLetter(l); };
                })(letter);
                container.appendChild(btn);
            }
            document.getElementById('selectedLetters').textContent = '_';
            document.getElementById('backspaceBtn').disabled = true;
            document.getElementById('playLettersBtn').style.display = 'none';
            document.getElementById('feedback').textContent = '';
            isWrongAttempt = false;
        }

        function selectLetter(letter) {
            currentLetters.push(letter);
            updateSelectedDisplay();
            updateBackspaceButton();
            checkAutoSubmit();
        }

        function checkAutoSubmit() {
            var word = practiceWords[currentIndex];
            var typed = currentLetters.join('');
            if (typed.length === word.length) {
                setTimeout(function() { submitSpelling(); }, 300);
            }
        }

        function updateSelectedDisplay() {
            var display = currentLetters.length > 0 ? currentLetters.join('') : '_';
            document.getElementById('selectedLetters').textContent = display;
        }

        function backspaceLetters() {
            if (currentLetters.length > 0) {
                currentLetters.pop();
                updateSelectedDisplay();
                updateBackspaceButton();
            }
        }

        function updateBackspaceButton() {
            document.getElementById('backspaceBtn').disabled = currentLetters.length === 0;
        }

        function clearLetters() {
            currentLetters = [];
            updateSelectedDisplay();
            updateBackspaceButton();
        }

        function submitSpelling() {
            if (isAutoAdvancing) return;
            var typed = currentLetters.join('');
            var correct = practiceWords[currentIndex];

            if (typed.toLowerCase() === correct.toLowerCase()) {
                var feedbackEl = document.getElementById('feedback');
                feedbackEl.textContent = '+1 Point!';
                feedbackEl.className = 'feedback correct';
                feedbackEl.style.animation = 'none';
                setTimeout(function() { feedbackEl.style.animation = 'popBubble 1s ease-out'; }, 10);

                marks++;
                document.getElementById('marksValue').textContent = marks;
                isAutoAdvancing = true;
                stopSpeaking();
                clearInterval(wordTimer);
                setTimeout(function() {
                    isAutoAdvancing = false;
                    moveToNextWord();
                }, 1000);
            } else {
                if (!isWrongAttempt) {
                    isWrongAttempt = true;
                    document.getElementById('feedback').textContent = 'Incorrect. Try again or use Play Letters.';
                    document.getElementById('feedback').className = 'feedback incorrect';
                    document.getElementById('playLettersBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('feedback').textContent = 'Wrong: ' + correct;
                    document.getElementById('feedback').className = 'feedback incorrect';
                }
            }
        }

        function skipWord() {
            var word = practiceWords[currentIndex];
            document.getElementById('feedback').textContent = 'Skipped: ' + word;
            document.getElementById('feedback').className = 'feedback incorrect';
            setTimeout(function() { moveToNextWord(); }, 1500);
        }

        function moveToNextWord() {
            stopSpeaking();
            currentIndex++;
            if (currentIndex >= practiceWords.length) {
                endPractice();
            } else {
                clearLetters();
                generateAlphabetButtons();
                updatePracticeDisplay();
                startWordTimer();
                setTimeout(function() {
                    speakPracticeWord();
                }, 500);
            }
        }

        function updatePracticeDisplay() {
            var progress = Math.round(currentIndex / practiceWords.length * 100);
            document.getElementById('practiceProgress').style.width = progress + '%';
            document.getElementById('practiceProgress').textContent = currentIndex + '/' + practiceWords.length;
        }

        function endPractice() {
            clearInterval(wordTimer);
            stopSpeaking();
            var percentage = Math.round(marks / totalMarks * 100);
            alert('Practice Complete!\nMarks: ' + marks + ' / ' + totalMarks + ' (' + percentage + '%)');
            exitPractice();
        }

        function exitPractice() {
            clearInterval(wordTimer);
            stopSpeaking();
            document.getElementById('practiceSection').classList.remove('active');
            document.getElementById('modeSelection').classList.add('active');
        }

        function backToMode() {
            stopSpeaking();
            if (learnTimer) clearTimeout(learnTimer);
            document.getElementById('gradeSubjectSelection').classList.remove('active');
            document.getElementById('gradeSubjectSelectionPractice').classList.remove('active');
            document.getElementById('practiceSetSelection').classList.remove('active');
            document.getElementById('modeSelection').classList.add('active');
        }

        function exitToMode() {
            stopSpeaking();
            if (learnTimer) clearTimeout(learnTimer);
            document.getElementById('learningSection').classList.remove('active');
            document.getElementById('modeSelection').classList.add('active');
        }

        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
